sudo: required
dist: trusty
group: deprecated-2017Q4
env:
    global:
        # Travis currently only provides two cores per VM:
        # https://docs.travis-ci.com/user/reference/overview/.
        # There is at least one open issue asking that this info be provided to the
        # client environment: https://github.com/travis-ci/travis-ci/issues/4696.
        # For now just hardcode the expected value.
        - CORE_COUNT=2

    matrix:
        - OS_TYPE=fedora
          INSTALL_REQUIREMENTS="dnf repolist; dnf install -y gcc meson sudo langpacks-zh_CN ed ncurses vi"

        # Note: Meson 0.44.0 is the newest version that works with Python
        # 3.4 available on OpenSuse Leap. See issue #430.
        - OS_TYPE=opensuse
          INSTALL_REQUIREMENTS="zypper refresh; zypper in -y gcc python3 python3-pip ninja sudo glibc-locale glibc-devel ed ncurses-utils vim; pip3 install meson==0.44.0"

        # Ubuntu requires explicitly generating en_US.UTF-8 locale
        - OS_TYPE=ubuntu
          INSTALL_REQUIREMENTS="apt-get update; apt-get install -y gcc python3 sudo locales ed vim meson; locale-gen en_US.UTF-8"

        # Debian requires explicitly generating en_US.UTF-8 locale too
        - OS_TYPE=debian
          INSTALL_REQUIREMENTS="apt-get update; apt-get install -y gcc python3 python3-pip ninja-build sudo locales ed vim procps; pip3 install meson==0.44.0; sed -i '/# en_US.UTF-8 UTF-8/s/..//' /etc/locale.gen && locale-gen"

services:
    - docker

before_install:
    - docker pull ${OS_TYPE}

script:
    # TODO: Check how to set MESON_TESTTHREADS dynamically.
    # TODO: Change "meson test" to "meson test --setup=malloc" when #398 is fixed.
    # TODO: When we run the tests with --setup=malloc change "testlog.txt" to "testlog-malloc.txt".
    - echo > build.sh "set -e;
        export LANG=en_US.UTF-8;
        export CFLAGS='-fno-strict-aliasing -Wno-unknown-pragmas -Wno-missing-braces -Wno-unused-result -Wno-return-type -Wno-int-to-pointer-cast -Wno-parentheses -Wno-unused -Wno-unused-but-set-variable -Wno-cpp -Wno-char-subscripts';
        cd /source;
        mkdir build;
        cd build;
        echo ==== Configuring the build;
        meson;
        echo ==== Building the code;
        ninja;
        echo ==== Running unit tests;
        ulimit -n 1024;
        export MESON_TESTTHREADS=$(( 4 * CORE_COUNT ));
        if ! meson test; then cat meson-logs/testlog.txt; exit 1; fi;
        "

    - chmod a+x build.sh

    - docker run -v $TRAVIS_BUILD_DIR:/source ${OS_TYPE} bash -c "set -e;
        ${INSTALL_REQUIREMENTS};
        useradd --create-home test;
        chown -R test /source;
        sudo -u test /source/build.sh"
